<div class="corte-container">
  <!-- WIZARD DE PASOS -->
  <div class="wizard-steps" *ngIf="showFilters">
    <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
      <div class="step-number">1</div>
      <div class="step-label">Cajero</div>
    </div>
    <div class="step-line" [class.active]="currentStep > 1"></div>
    <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
      <div class="step-number">2</div>
      <div class="step-label">Tipo</div>
    </div>
    <div class="step-line" [class.active]="currentStep > 2"></div>
    <div class="step" [class.active]="currentStep >= 3">
      <div class="step-number">3</div>
      <div class="step-label">Consultar</div>
    </div>
  </div>

  <div class="corte-card">
    <!-- FILTROS CON WIZARD -->
    <div class="filter-wizard" *ngIf="showFilters">
      <div class="wizard-header">
        <h1>Corte de Caja</h1>
        <p class="subtitle">Selecciona el cajero y tipo de consulta</p>
      </div>

      <!-- PASO 1: CAJERO -->
      <div class="wizard-panel" *ngIf="currentStep === 1">
        <label class="section-label">Selecciona el cajero</label>
        <div class="user-grid">
          <button type="button" 
                  class="user-card"
                  *ngFor="let u of usuarios"
                  [class.selected]="selectedUserId === u.id"
                  (click)="selectUser(u.id)">
            <div class="user-avatar">
              <i class="bi bi-person-fill"></i>
            </div>
            <div class="user-info">
              <div class="user-name">{{ u.usuario }}</div>
              <div class="user-role">{{ u.rol }}</div>
            </div>
            <i class="bi bi-check-circle-fill check-icon"></i>
          </button>
          <div class="empty-state" *ngIf="usuarios.length === 0">
            <i class="bi bi-people"></i>
            <p>No hay cajeros disponibles</p>
          </div>
        </div>
        <div class="wizard-actions">
          <button class="btn btn-primary btn-lg" 
                  [disabled]="!selectedUserId"
                  (click)="nextStep()">
            Continuar
            <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- PASO 2: MODO -->
      <div class="wizard-panel" *ngIf="currentStep === 2">
        <button class="btn-back" (click)="prevStep()">
          <i class="bi bi-arrow-left"></i> Cambiar cajero
        </button>

        <div class="selected-user-badge">
          <i class="bi bi-person-check-fill"></i>
          <span>{{ selectedUserName }}</span>
        </div>

        <label class="section-label mt-4">¿Qué deseas hacer?</label>
        <div class="mode-grid">
          <button type="button"
                  class="mode-card"
                  [class.selected]="mode==='TURNO'"
                  (click)="selectMode('TURNO')">
            <div class="mode-icon turno">
              <i class="bi bi-clock-history"></i>
            </div>
            <div class="mode-content">
              <h3>Cerrar turno</h3>
              <p>Cierra el turno activo del cajero y registra el efectivo entregado</p>
              <div class="mode-badge" *ngIf="mode==='TURNO' && openShiftId">
                <i class="bi bi-check-circle-fill"></i>
                Turno #{{ openShiftId }} detectado
              </div>
              <div class="mode-badge warning" *ngIf="mode==='TURNO' && selectedUserId && !openShiftId">
                <i class="bi bi-exclamation-triangle-fill"></i>
                Sin turno abierto
              </div>
            </div>
            <i class="bi bi-check-circle-fill check-icon"></i>
          </button>

          <button type="button"
                  class="mode-card"
                  [class.selected]="mode==='DIA'"
                  (click)="selectMode('DIA')">
            <div class="mode-icon dia">
              <i class="bi bi-calendar3"></i>
            </div>
            <div class="mode-content">
              <h3>Reporte por fecha</h3>
              <p>Consulta movimientos de caja en un rango de fechas específico</p>
            </div>
            <i class="bi bi-check-circle-fill check-icon"></i>
          </button>
        </div>

        <!-- CONTROLES FECHA PARA DIA -->
        <div class="date-controls" *ngIf="mode === 'DIA'">
          <label class="section-label">Rango de fechas</label>
          <div class="preset-chips">
            <button type="button" 
                    class="chip"
                    [class.active]="preset==='HOY'"
                    (click)="setPreset('HOY')">
              <i class="bi bi-calendar-day"></i> Hoy
            </button>
            <button type="button" 
                    class="chip"
                    [class.active]="preset==='AYER'"
                    (click)="setPreset('AYER')">
              <i class="bi bi-calendar-minus"></i> Ayer
            </button>
            <button type="button" 
                    class="chip"
                    [class.active]="preset==='SEMANA'"
                    (click)="setPreset('SEMANA')">
              <i class="bi bi-calendar-week"></i> Esta semana
            </button>
          </div>

          <div class="date-range">
            <div class="date-input-group">
              <label>Desde</label>
              <input type="date" class="form-control" [(ngModel)]="desdeStr">
            </div>
            <div class="date-separator">
              <i class="bi bi-arrow-right"></i>
            </div>
            <div class="date-input-group">
              <label>Hasta</label>
              <input type="date" class="form-control" [(ngModel)]="hastaStr">
            </div>
          </div>
        </div>

        <div class="wizard-actions">
          <button class="btn btn-primary btn-lg" 
                  [disabled]="loading || !canConsult"
                  (click)="consultar()">
            <span *ngIf="!loading">
              <i class="bi bi-search"></i> Consultar movimientos
            </span>
            <span *ngIf="loading">
              <i class="bi bi-arrow-repeat spinner"></i> Consultando...
            </span>
          </button>
        </div>
      </div>
    </div>

    <!-- RESULTADOS -->
    <div class="results-view" *ngIf="!showFilters">
      <!-- HEADER COMPACTO -->
      <div class="results-header">
        <div class="header-left">
          <button class="btn-icon" (click)="editarFiltros()" title="Cambiar filtros">
            <i class="bi bi-arrow-left"></i>
          </button>
          <div class="header-info">
            <h2>
              {{ mode === 'TURNO' ? 'Cierre de turno' : 'Reporte de caja' }}
              <span class="turno-badge" *ngIf="mode==='TURNO' && openShiftId">
                #{{ openShiftId }}
              </span>
            </h2>
            <div class="header-meta">
              <span class="meta-item">
                <i class="bi bi-person-fill"></i>
                {{ selectedUserName }}
              </span>
              <span class="meta-divider">·</span>
              <span class="meta-item" *ngIf="mode === 'DIA'">
                <i class="bi bi-calendar3"></i>
                {{ desdeStr }} → {{ hastaStr }}
              </span>
              <span class="meta-item" *ngIf="mode === 'TURNO' && openShiftOpenedAt">
                <i class="bi bi-clock"></i>
                Abierto {{ openShiftOpenedAt | date:'HH:mm' }}
              </span>
            </div>
          </div>
        </div>

        <button class="btn btn-success btn-lg"
                [disabled]="loading || !canClose"
                (click)="abrirModalCierre()">
          <i class="bi bi-check2-circle"></i>
          {{ mode === 'TURNO' ? 'Cerrar turno' : 'Registrar corte' }}
        </button>
      </div>

      <!-- KPIs MEJORADOS -->
      <div class="kpis-section">
        <div class="kpi-card entradas">
          <div class="kpi-icon">
            <i class="bi bi-arrow-down-circle"></i>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Entradas</div>
            <div class="kpi-value">{{ summary.total_entradas | currency:'MXN':'symbol-narrow':'1.2-2' }}</div>
          </div>
        </div>

        <div class="kpi-card salidas">
          <div class="kpi-icon">
            <i class="bi bi-arrow-up-circle"></i>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Salidas</div>
            <div class="kpi-value">{{ summary.total_salidas | currency:'MXN':'symbol-narrow':'1.2-2' }}</div>
          </div>
        </div>

        <div class="kpi-card neto">
          <div class="kpi-icon">
            <i class="bi bi-calculator"></i>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Neto</div>
            <div class="kpi-value">{{ summary.neto | currency:'MXN':'symbol-narrow':'1.2-2' }}</div>
          </div>
        </div>

        <div class="kpi-card esperado" *ngIf="mode === 'TURNO'">
          <div class="kpi-icon">
            <i class="bi bi-wallet2"></i>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Efectivo esperado</div>
            <div class="kpi-value">{{ cashExpected | currency:'MXN':'symbol-narrow':'1.2-2' }}</div>
            <div class="kpi-hint">Incluye fondo: {{ openShiftOpeningCash | currency:'MXN':'symbol-narrow':'1.2-2' }}</div>
          </div>
        </div>
      </div>

      <!-- TABLA MEJORADA -->
      <div class="movements-section">
        <div class="section-header">
          <h3>
            <i class="bi bi-list-ul"></i>
            Movimientos ({{ movimientos.length }})
          </h3>
        </div>

        <div class="table-container" *ngIf="!loading; else loadingTpl">
          <table class="movements-table" *ngIf="movimientos.length > 0">
            <thead>
              <tr>
                <th class="col-fecha">Fecha y hora</th>
                <th class="col-tipo">Tipo</th>
                <th class="col-ref">Referencia</th>
                <th class="col-monto">Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let m of movimientos" class="movement-row">
                <td class="col-fecha">
                  <div class="datetime-cell">
                    <span class="date">{{ m.datee | date:'dd/MM/yyyy' }}</span>
                    <span class="time">{{ m.datee | date:'HH:mm' }}</span>
                  </div>
                </td>
                <td class="col-tipo">
                  <span class="type-badge" [attr.data-type]="m.typee">
                    <i class="bi" [ngClass]="{
                      'bi-cart-check': m.typee === 'SALE',
                      'bi-piggy-bank': m.typee === 'DEPOSIT',
                      'bi-cash-coin': m.typee === 'WITHDRAW',
                      'bi-arrow-counterclockwise': m.typee === 'REFUND'
                    }"></i>
                    {{ m.typee }}
                  </span>
                </td>
                <td class="col-ref">
                  <div class="ref-cell">
                    <span class="ref-text">{{ m.reference || ('#' + (m.reference_id ?? '—')) }}</span>
                    <span class="ref-note" *ngIf="m.note" [title]="m.note">
                      <i class="bi bi-sticky"></i>
                    </span>
                  </div>
                </td>
                <td class="col-monto">
                  <span class="amount" [class.positive]="m.amount >= 0" [class.negative]="m.amount < 0">
                    {{ m.amount | currency:'MXN':'symbol-narrow':'1.2-2' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="empty-state" *ngIf="movimientos.length === 0">
            <i class="bi bi-inbox"></i>
            <h4>Sin movimientos</h4>
            <p>No se encontraron movimientos en el período seleccionado</p>
          </div>
        </div>

        <ng-template #loadingTpl>
          <div class="loading-state">
            <i class="bi bi-arrow-repeat spinner"></i>
            <p>Cargando movimientos...</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- MODAL CIERRE MEJORADO -->
    <div class="modal-overlay" *ngIf="showCloseModal" (click)="!closing && cerrarModalCierre()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            <i class="bi bi-check2-circle"></i>
            {{ mode === 'TURNO' ? 'Cerrar turno' : 'Registrar corte' }}
          </h3>
          <button class="btn-close" (click)="cerrarModalCierre()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="modal-info-card">
            <div class="info-row">
              <span class="info-label">Cajero</span>
              <span class="info-value">{{ selectedUserName }}</span>
            </div>
            <div class="info-row" *ngIf="mode === 'TURNO'">
              <span class="info-label">Turno</span>
              <span class="info-value">
                #{{ openShiftId }}
                <span class="badge-sm badge-success">Abierto</span>
              </span>
            </div>
            <div class="info-row" *ngIf="mode === 'DIA'">
              <span class="info-label">Período</span>
              <span class="info-value">{{ desdeStr }} → {{ hastaStr }}</span>
            </div>
          </div>

          <div class="amount-display expected">
            <div class="amount-label">
              <i class="bi bi-calculator-fill"></i>
              Efectivo esperado
            </div>
            <div class="amount-value">{{ cashExpected | currency:'MXN':'symbol-narrow':'1.2-2' }}</div>
            <div class="amount-hint">
              {{ mode === 'TURNO' 
                  ? 'Movimientos + fondo inicial (' + (openShiftOpeningCash | currency:'MXN':'symbol-narrow':'1.2-2') + ')'
                  : 'Calculado por movimientos del período' }}
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-cash-stack"></i>
              Efectivo entregado
            </label>
            <div class="input-with-currency">
              <span class="currency-symbol">$</span>
              <input type="number"
                     min="0" 
                     step="0.01"
                     class="form-control form-control-lg"
                     [(ngModel)]="cashDelivered"
                     placeholder="0.00"
                     autofocus>
            </div>
          </div>

          <div class="amount-display difference" [class.positive]="cashDiff >= 0" [class.negative]="cashDiff < 0">
            <div class="amount-label">
              <i class="bi" [ngClass]="cashDiff >= 0 ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'"></i>
              Diferencia
            </div>
            <div class="amount-value">{{ cashDiff | currency:'MXN':'symbol-narrow':'1.2-2' }}</div>
            <div class="amount-hint" *ngIf="cashDiff !== 0">
              {{ cashDiff > 0 ? 'Sobrante' : 'Faltante' }}
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-pencil-square"></i>
              Notas (opcional)
            </label>
            <textarea class="form-control" 
                      rows="3"
                      [(ngModel)]="closeNotes"
                      placeholder="Observaciones sobre el cierre..."></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-ghost" [disabled]="closing" (click)="cerrarModalCierre()">
            Cancelar
          </button>
          <button class="btn btn-primary btn-lg"
                [disabled]="closing || cashDelivered === null || (mode==='TURNO' && !openShiftId)"
                (click)="confirmarCierreReal()">
          <ng-container *ngIf="!closing; else closingTpl">
            <i class="bi bi-check-circle"></i>
            Confirmar cierre
          </ng-container>
          <ng-template #closingTpl>
            <i class="bi bi-arrow-repeat spinner"></i>
            Cerrando...
          </ng-template>
        </button>
        </div>
      </div>
    </div>
  </div>
</div>
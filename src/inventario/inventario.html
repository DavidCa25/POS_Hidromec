<div class="castrol-table-container mt-4">
  <div class="inv-header-section">
    <div class="inv-header-content">
      <div class="inv-title-wrapper">
        <i class="bi bi-box-seam inv-icon"></i>
        <h1 class="inv-main-title">Inventario</h1>
      </div>
      <p class="inv-subtitle">Administra productos, stock y precios</p>
    </div>

    <div class="inv-actions-group">
      <button class="castrol-btn-add" type="button" (click)="abrirProductoModal()">
        <i class="bi bi-plus-circle-dotted me-2"></i> Agregar Producto
      </button>

      <button class="castrol-btn-color" type="button" (click)="abrirBrandModal()">
        <i class="bi bi-tags me-2"></i> Agregar Marca
      </button>

      <button class="castrol-btn-color" type="button" (click)="abrirCategoryModal()">
        <i class="bi bi-folder-plus me-2"></i> Agregar Categoría
      </button>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3" style="gap:14px; flex-wrap:wrap;">
    <div class="ventas-stats-badge">
      <i class="bi bi-list-check"></i>
      <span>{{ totalItems }} productos</span>
    </div>

    <div class="ventas-tools">
      <div class="ventas-search">
        <i class="bi bi-search"></i>
        <input
          type="search"
          placeholder="Buscar por número de parte, producto, marca, categoría, proveedor..."
          [(ngModel)]="filtro"
          (ngModelChange)="onFilterChange()"
        />
        <button
          type="button"
          class="clear-btn"
          *ngIf="filtro"
          (click)="clearFilter()"
          title="Limpiar"
        >
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="ventas-meta">
        <div class="range">
          {{ pageStartIndex + 1 }}–{{ pageEndIndex }} de {{ totalItems }}
        </div>

        <div class="ventas-page-size">
          <span>Mostrar</span>
          <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange($event)">
            <option *ngFor="let n of pageSizeOptions" [ngValue]="n">{{ n }}</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="castrol-table">
      <thead>
        <tr>
          <th style="width:70px;">#</th>
          <th style="min-width:180px;">Número de parte</th>
          <th style="min-width:260px;">Producto</th>
          <th style="width:140px;">Precio</th>
          <th style="width:110px;">Stock</th>
          <th style="min-width:160px;">Categoría</th>
          <th style="min-width:160px;">Marca</th>
          <th style="min-width:200px;">Proveedor (Default)</th>
          <th style="width:170px;">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let item of inventarioPaginado; let i = index">
          <td class="fw-semibold">{{ pageStartIndex + i + 1 }}</td>
          <td>{{ item.part_number ?? '-' }}</td>
          <td>{{ item.product_name ?? item.nombre ?? '-' }}</td>

          <td class="fw-semibold">
            {{ (item.price ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
          </td>

          <td>{{ item.stock ?? '-' }}</td>
          <td>{{ item.category_name ?? '-' }}</td>
          <td>{{ item.brand_name ?? '-' }}</td>
          <td>
            <span class="supplier-badge" *ngIf="item.default_supplier_name; else noSup">
              {{ item.default_supplier_name }}
            </span>
            <ng-template #noSup>
              <span class="text-muted">—</span>
            </ng-template>
          </td>

          <td class="acciones-cell">
            <div class="action-group">
              <!-- ✅ botón proveedores -->
              <button class="action-btn btn-suppliers"
                      aria-label="Proveedores"
                      data-tooltip="Proveedores"
                      (click)="abrirProveedoresModal(item)">
                <i class="bi bi-truck"></i>
              </button>

              <button class="action-btn btn-edit" aria-label="Editar" data-tooltip="Editar">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.004 1.004 0 0 0 0-1.42l-2.34-2.34a1.004 1.004 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
                </svg>
              </button>

              <button class="action-btn btn-delete" aria-label="Eliminar" data-tooltip="Eliminar">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M9 3h6l1 1h4v2H4V4h4l1-1zm1 7h2v8h-2v-8zm4 0h2v8h-2v-8zM6 7h12l-1 13a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L6 7z"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>

        <tr *ngIf="inventarioPaginado.length === 0">
          <td colspan="9" class="text-muted text-center py-4">
            No hay datos de inventario disponibles.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="ventas-pager" *ngIf="totalItems > 0">
    <button class="pager-btn" (click)="prevPage()" [disabled]="page <= 1">
      <i class="bi bi-chevron-left"></i> Anterior
    </button>

    <div class="pager-pages">
      <button
        *ngFor="let p of pagesToShow"
        class="page-btn"
        [class.active]="p === page"
        [class.dots]="p === '...'"
        [disabled]="p === '...'"
        (click)="onPageClick(p)"
        type="button"
      >
        {{ p }}
      </button>
    </div>

    <button class="pager-btn" (click)="nextPage()" [disabled]="page >= totalPages">
      Siguiente <i class="bi bi-chevron-right"></i>
    </button>
  </div>

  <!-- ========================= -->
  <!-- Modal Agregar Producto (tu modal) -->
  <!-- ========================= -->
  <div class="producto-modal" *ngIf="productoModalAbierto">
    <h1 class="producto-modal-title"><b>Agregar producto</b></h1>
    <form autocomplete="off" (ngSubmit)="addProduct()" #formRef="ngForm">
      <div class="producto-form-grid">
        <div class="grid-col-span">
          <label>Marca</label>
          <select name="brand" [(ngModel)]="form.brand" required class="my-1 mr-sm-2">
            <option [ngValue]="null" disabled>Selecciona una</option>
            <option *ngFor="let brand of brands" [ngValue]="brand.id">{{brand.namee}}</option>
          </select>
        </div>

        <div>
          <label>Categoría</label>
          <select name="category" [(ngModel)]="form.category" required class="my-1 mr-sm-2">
            <option [ngValue]="null" disabled>Selecciona una</option>
            <option *ngFor="let cat of categorys" [ngValue]="cat.id">{{cat.namee}}</option>
          </select>
        </div>

        <div class="grid-col-span">
          <label>Número de parte</label>
          <input type="text" name="partNumber" [(ngModel)]="form.partNumber" required class="my-1 mr-sm-2">
        </div>

        <div class="grid-col-span-3">
          <label>Nombre</label>
          <input type="text" name="name" [(ngModel)]="form.name" required class="my-1 mr-sm-2">
        </div>

        <div>
          <label>Precio</label>
          <input type="number" step="0.01" name="price" [(ngModel)]="form.price" required class="my-1 mr-sm-2" placeholder="0.00">
        </div>

        <div>
          <label>Stock</label>
          <input type="number" name="stock" [(ngModel)]="form.stock" min="0" required class="my-1 mr-sm-2" placeholder="1">
        </div>
      </div>

      <div class="producto-modal-actions">
        <button type="button" class="producto-cancel-btn" (click)="cerrarProductoModal()">Cancelar</button>
        <button type="submit" class="producto-save-btn" [disabled]="formRef.invalid">Guardar</button>
      </div>
    </form>
  </div>

  <!-- ========================= -->
  <!-- ✅ Modal Proveedores -->
  <!-- ========================= -->
  <div class="modal-backdrop-soft" *ngIf="proveedoresModalAbierto" (click)="cerrarProveedoresModal()"></div>

  <div class="suppliers-modal" *ngIf="proveedoresModalAbierto">
    <div class="suppliers-modal-header">
      <div>
        <div class="suppliers-title">Proveedores del producto</div>
        <div class="suppliers-subtitle">
          {{ selectedProduct?.product_name ?? selectedProduct?.nombre ?? 'Producto' }}
          <span class="suppliers-pill">#{{ selectedProduct?.id }}</span>
        </div>
      </div>

      <button class="suppliers-close" type="button" (click)="cerrarProveedoresModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="suppliers-add-card">
      <div class="fw-semibold mb-2">Crear proveedor (CAT_suppliers)</div>
      <div class="row g-2 align-items-end">
        <div class="col-md-8">
          <label class="form-label">Nombre</label>
          <input class="form-control" [(ngModel)]="newSupplierName" name="newSupplierName" placeholder="Ej. CASTROL México">
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-outline-primary"
                  type="button"
                  [disabled]="creatingSupplier"
                  (click)="crearProveedorCatalogoYSeleccionar()">
            <i class="bi bi-plus-circle me-1"></i>
            {{ creatingSupplier ? 'Creando...' : 'Crear proveedor' }}
          </button>
        </div>
      </div>

      <hr class="my-3">
      <div class="fw-semibold mb-2">Vincular proveedor al producto</div>
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label">Proveedor</label>
          <select class="form-select" [(ngModel)]="supplierToAdd" name="supplierToAdd">
            <option [ngValue]="null" disabled>Selecciona un proveedor</option>
            <option *ngFor="let s of suppliersCatalog" [ngValue]="s.id">
              {{ s.nombre }}
            </option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Último costo (opcional)</label>
          <input class="form-control" type="number" step="0.01"
                 [(ngModel)]="supplierLastCost"
                 name="supplierLastCost"
                 placeholder="0.00">
        </div>

        <div class="col-md-3 d-flex gap-2 align-items-center justify-content-between">
          <label class="d-flex align-items-center gap-2 m-0">
            <input type="checkbox" [(ngModel)]="supplierIsDefault" name="supplierIsDefault">
            <span>Default</span>
          </label>

          <button type="button" class="btn btn-primary" (click)="agregarProveedorAlProducto()">
            <i class="bi bi-link-45deg me-1"></i> Vincular
          </button>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div class="suppliers-list">
      <div *ngIf="productSuppliers.length === 0" class="text-muted p-3">
        Este producto no tiene proveedores vinculados.
      </div>

      <div *ngFor="let r of productSuppliers" class="supplier-row">
        <div class="supplier-main">
          <div class="supplier-name">
            {{ r.supplier_name }}
            <span *ngIf="r.is_default" class="badge bg-success ms-2">Default</span>
            <span *ngIf="!r.active" class="badge bg-secondary ms-2">Inactivo</span>
          </div>

          <div class="supplier-meta">
            ID proveedor: <b>{{ r.supplier_id }}</b>
          </div>
        </div>

        <div class="supplier-actions">
          <div class="supplier-cost">
            <label>Último costo</label>
            <input type="number"
                   step="0.01"
                   class="form-control form-control-sm"
                   [(ngModel)]="r.last_cost"
                   name="last_cost_{{r.supplier_id}}">
          </div>

          <button class="btn btn-outline-secondary btn-sm"
                  type="button"
                  (click)="updateLastCost(r)">
            Guardar
          </button>

          <button class="btn btn-outline-success btn-sm"
                  type="button"
                  [disabled]="r.is_default"
                  (click)="setDefaultSupplier(r)">
            Default
          </button>

          <button class="btn btn-outline-danger btn-sm"
                  type="button"
                  (click)="quitarProveedor(r)">
            Quitar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ========================= -->
<!-- ✅ Modal: Agregar Marca -->
<!-- ========================= -->
<div class="modal-backdrop-soft"
     *ngIf="brandModalAbierto"
     (click)="cerrarBrandModal()"></div>

<div class="mini-modal" *ngIf="brandModalAbierto">
  <div class="mini-modal-header">
    <div class="mini-modal-title">
      <i class="bi bi-tags me-2"></i> Agregar marca
    </div>
    <button type="button" class="mini-close" (click)="cerrarBrandModal()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <div class="mini-modal-body">
    <label class="form-label">Nombre de la marca</label>
    <input class="form-control"
           [(ngModel)]="newBrandName"
           name="newBrandName"
           placeholder="Ej. CASTROL"
           (keydown.enter)="crearBrandCatalogo()">
  </div>

  <div class="mini-modal-actions">
    <button type="button" class="btn btn-outline-secondary" (click)="cerrarBrandModal()">
      Cancelar
    </button>
    <button type="button"
            class="btn btn-primary"
            [disabled]="creatingBrand"
            (click)="crearBrandCatalogo()">
      {{ creatingBrand ? 'Guardando...' : 'Guardar' }}
    </button>
  </div>
</div>

<!-- ========================= -->
<!-- ✅ Modal: Agregar Categoría -->
<!-- ========================= -->
<div class="modal-backdrop-soft"
     *ngIf="categoryModalAbierto"
     (click)="cerrarCategoryModal()"></div>

<div class="mini-modal" *ngIf="categoryModalAbierto">
  <div class="mini-modal-header">
    <div class="mini-modal-title">
      <i class="bi bi-folder-plus me-2"></i> Agregar categoría
    </div>
    <button type="button" class="mini-close" (click)="cerrarCategoryModal()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <div class="mini-modal-body">
    <label class="form-label">Nombre de la categoría</label>
    <input class="form-control"
           [(ngModel)]="newCategoryName"
           name="newCategoryName"
           placeholder="Ej. Refacciones"
           (keydown.enter)="crearCategoryCatalogo()">
  </div>

  <div class="mini-modal-actions">
    <button type="button" class="btn btn-outline-secondary" (click)="cerrarCategoryModal()">
      Cancelar
    </button>
    <button type="button"
            class="btn btn-primary"
            [disabled]="creatingCategory"
            (click)="crearCategoryCatalogo()">
      {{ creatingCategory ? 'Guardando...' : 'Guardar' }}
    </button>
  </div>
</div>


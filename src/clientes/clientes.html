<div class="corte-container">
  <div class="corte-card">
    <!-- Header -->
    <div class="corte-header">
      <h2>Clientes</h2>
      <div class="header-right">
        <span class="hoy">{{ hoy | date:'EEEE d MMM, h:mm a' }}</span>
        <button class="btn btn-primary" (click)="nuevo()">+ Nuevo cliente</button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
      <div class="filter-row">
        <div class="filter-group">
          <label>Buscar</label>
          <input class="form-control" [(ngModel)]="search" placeholder="Nombre, teléfono o correo">
        </div>

        <div class="filter-group">
          <label>Estado</label>
          <select class="form-control" [(ngModel)]="estado">
            <option value="todos">Todos</option>
            <option value="activos">Activos</option>
            <option value="inactivos">Inactivos</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Presets</label>
          <div class="preset-group">
            <button class="preset" [class.active]="preset==='todos'" (click)="setPreset('todos')">Todos</button>
            <button class="preset" [class.active]="preset==='con_saldo'" (click)="setPreset('con_saldo')">Con saldo</button>
            <button class="preset" [class.active]="preset==='vencidos'" (click)="setPreset('vencidos')">Vencidos</button>
          </div>
        </div>

        <div class="filter-actions">
          <button class="btn btn-ghost" (click)="search=''; estado='todos'; setPreset('todos')">Limpiar</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="resumen-grid">
      <div class="kpi-card">
        <div class="kpi-title">Clientes</div>
        <div class="kpi-value">{{ kpiTotal }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Con saldo</div>
        <div class="kpi-value">{{ kpiConSaldo }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Vencidos</div>
        <div class="kpi-value">{{ kpiVencidos }}</div>
      </div>
      <div class="kpi-card total">
        <div class="kpi-title">Saldo total</div>
        <div class="kpi-value">$ {{ kpiSaldoTotal | number:'1.2-2' }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Activos</div>
        <div class="kpi-value">{{ activosCount }}</div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="tabla-wrap">
      <table class="tabla-corte">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Contacto</th>
            <th class="right">Límite</th>
            <th class="right">Saldo</th>
            <th>Estado</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of clientesView">
            <td class="strong">
              {{ c.name }}
              <span *ngIf="!c.active" class="badge badge.tarjeta" style="margin-left:6px;">Inactivo</span>
            </td>
            <td>
              <div class="mono">{{ c.phone || '-' }}</div>
              <div class="nota" *ngIf="c.email">{{ c.email }}</div>
            </td>
            <td class="num mono">$ {{ c.creditLimit | number:'1.2-2' }}</td>
            <td class="num mono">$ {{ c.balance | number:'1.2-2' }}</td>
            <td>
              <span [ngClass]="badgeEstado(c).cls">{{ badgeEstado(c).text }}</span>
              <span *ngIf="c.overdueCount>0" class="badge badge.tarjeta" style="margin-left:6px;">
                {{ c.overdueCount }} venc.
              </span>
            </td>
            <td class="right">
              <button class="btn btn-ghost" (click)="abonar(c)">Abonar</button>
              <button class="btn btn-ghost" (click)="editar(c)">Editar</button>
            </td>
          </tr>
        </tbody>
      </table>

      <p class="nota" *ngIf="clientesView.length===0">Sin resultados</p>
    </div>
  </div>

  <!-- Modal Nuevo/Editar -->
  <div class="cierre-modal" *ngIf="showModal" style="position:fixed; inset:0; background:rgba(0,0,0,.3); display:flex; align-items:center; justify-content:center;">
    <div class="cierre-dialog modal-content" style="background:#fff; padding:1.2rem 1.2rem 1.4rem; border-radius:20px; width: 96%; max-width: 560px;">
      <h3 style="margin:0 0 .6rem; font-size:1.4rem; font-weight:800;">
        {{ editing ? 'Editar cliente' : 'Nuevo cliente' }}
      </h3>

      <div class="filter-row" style="grid-template-columns: 1fr 1fr;">
        <div class="filter-group">
          <label>Nombre</label>
          <input class="form-control" [(ngModel)]="form.name">
        </div>
        <div class="filter-group">
          <label>Teléfono</label>
          <input class="form-control" [(ngModel)]="form.phone">
        </div>
        <div class="filter-group">
          <label>Correo</label>
          <input class="form-control" [(ngModel)]="form.email">
        </div>
        <div class="filter-group">
          <label>Límite de crédito</label>
          <input class="form-control" type="number" step="0.01" [(ngModel)]="form.creditLimit">
        </div>
        <div class="filter-group">
          <label>Días de plazo</label>
          <input class="form-control" type="number" [(ngModel)]="form.termsDays">
        </div>
        <div class="filter-group">
          <label>Activo</label>
          <select class="form-control" [(ngModel)]="form.active">
            <option [ngValue]="true">Sí</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>
      </div>

      <div class="nota" style="text-align:left;">
      </div>
      <div class="filter-row" style="grid-template-columns: 1fr 1fr;">
        <div class="filter-group">
          <label>Saldo (demo)</label>
          <input class="form-control" type="number" step="0.01" [(ngModel)]="form.balance">
        </div>
        <div class="filter-group">
          <label># vencidos (demo)</label>
          <input class="form-control" type="number" [(ngModel)]="form.overdueCount">
        </div>
      </div>

      <div style="display:flex; gap:.6rem; justify-content:flex-end; margin-top:1rem;">
        <button class="btn btn-ghost" (click)="cerrarModal()">Cancelar</button>
        <button class="btn btn-primary" (click)="guardar()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<div class="cierre-modal"
       *ngIf="showAbonoModal"
       style="position:fixed; inset:0; background:rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; z-index:1100;">
    <div class="cierre-dialog modal-content"
         style="background:#fff; padding:1.2rem 1.4rem 1.4rem; border-radius:22px; width: 96%; max-width: 780px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.4rem;">
        <h3 style="margin:0; font-size:1.4rem; font-weight:800;">
          Abonar a crédito
        </h3>
        <button class="btn btn-ghost" (click)="cerrarAbonoModal()">✕</button>
      </div>

      <div *ngIf="abonoCliente" style="margin-bottom:.6rem; font-size:.95rem;">
        <div style="font-weight:600;">{{ abonoCliente.name }}</div>
        <div class="nota">
          Saldo total: $ {{ abonoCliente.balance | number:'1.2-2' }}
          <span *ngIf="abonoCliente.overdueCount>0">
            — {{ abonoCliente.overdueCount }} vencida(s)
          </span>
        </div>
      </div>

      <div class="filter-row"
           style="grid-template-columns: minmax(0, 1.35fr) minmax(0, .95fr); align-items:flex-start; gap:1rem;">
        <!-- Columna izquierda: ventas -->
        <div class="filter-group">
          <label>Ventas a crédito pendientes</label>
          <div style="border-radius:1rem; border:1px solid #e2e8f0; max-height:320px; overflow:auto;">

            <table class="tabla-corte" style="margin:0; font-size:.9rem;">
              <thead>
                <tr>
                  <th style="width:36px;"></th>
                  <th>Fecha</th>
                  <th class="right">Total</th>
                  <th class="right">Pagado</th>
                  <th class="right">Saldo</th>
                  <th>Vence</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="loadingVentas">
                  <td colspan="6" style="text-align:center; padding:.9rem;">
                    Cargando ventas...
                  </td>
                </tr>

                <tr *ngFor="let v of ventasCliente"
                    [class.selected-row]="v.id === selectedSaleId"
                    (click)="selectedSaleId = v.id; abonoAmount = v.balance"
                    style="cursor:pointer;">
                  <td>
                    <input type="radio"
                           [checked]="v.id === selectedSaleId"
                           (click)="$event.stopPropagation(); selectedSaleId = v.id; abonoAmount = v.balance;">
                  </td>
                  <td>{{ v.datee | date:'dd/MM/yyyy HH:mm' }}</td>
                  <td class="right">$ {{ v.total | number:'1.2-2' }}</td>
                  <td class="right">$ {{ v.paid_amount | number:'1.2-2' }}</td>
                  <td class="right">$ {{ v.balance | number:'1.2-2' }}</td>
                  <td>
                    <span *ngIf="v.due_date; else sinFecha">
                      {{ v.due_date | date:'dd/MM/yyyy' }}
                    </span>
                    <ng-template #sinFecha>
                      <span class="nota">Sin fecha</span>
                    </ng-template>
                  </td>
                </tr>

                <tr *ngIf="!loadingVentas && ventasCliente.length === 0">
                  <td colspan="6" style="text-align:center; padding:.9rem;">
                    No hay ventas a crédito con saldo pendiente para este cliente.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Columna derecha: datos de abono -->
        <div class="filter-group">
          <label>Monto del abono</label>
          <input class="form-control"
                 type="number"
                 step="0.01"
                 min="0"
                 [(ngModel)]="abonoAmount">

          <div class="filter-group" style="margin-top:.7rem;">
            <label>Método de pago</label>
            <select class="form-control"
                    [(ngModel)]="abonoPaymentMethod">
              <option value="EFECTIVO">Efectivo</option>
              <option value="TARJETA">Tarjeta</option>
              <option value="TRANSFERENCIA">Transferencia</option>
            </select>
          </div>

          <div class="filter-group" style="margin-top:.7rem;">
            <label>Nota (opcional)</label>
            <textarea class="form-control"
                      rows="3"
                      [(ngModel)]="abonoNote"
                      style="resize:vertical; border-radius:0.9rem;"></textarea>
          </div>

          <div class="nota" style="margin-top:.6rem;">
            Selecciona una venta, ajusta el monto si es parcial y confirma el abono.
          </div>
        </div>
      </div>

      <div style="display:flex; gap:.6rem; justify-content:flex-end; margin-top:1rem;">
        <button class="btn btn-ghost" (click)="cerrarAbonoModal()" [disabled]="savingAbono">
          Cancelar
        </button>
        <button class="btn btn-primary"
                (click)="confirmarAbono()"
                [disabled]="savingAbono || ventasCliente.length === 0">
          {{ savingAbono ? 'Guardando...' : 'Confirmar abono' }}
        </button>
      </div>
    </div>
  </div>
